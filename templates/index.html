<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>ì•¼êµ¬ í¬ì§€ì…˜ ì¸ì‹ ì—°êµ¬ ëŒ€ì‹œë³´ë“œ</title>

  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <style>
    body {
      background-color: #f3f4f6;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .navbar-brand span {
      font-weight: 600;
    }
    .page-subtitle {
      font-size: 0.9rem;
      color: #6b7280;
    }
    .card {
      border-radius: 12px;
    }
    .upload-area {
      border-radius: 12px;
      background: #ffffff;
      border: 1px dashed #d1d5db;
      padding: 16px 18px;
    }
    .upload-area.dragover {
      border-color: #2563eb;
      background-color: #eff6ff;
    }
    .upload-icon {
      font-size: 2.2rem;
    }
    .scroll-table {
      max-height: 260px;
      overflow-y: auto;
    }
    .scroll-table table {
      margin-bottom: 0;
    }
    .result-img-wrapper {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #111827;
      padding: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: auto;
      max-height: 480px;
    }
    .result-img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 8px;
      transition: transform 0.15s ease-out;
      transform-origin: center center;
    }
    .result-video {
      max-width: 100%;
      max-height: 100%;
      border-radius: 8px;
    }
    .metric-badge {
      font-size: 0.8rem;
      font-weight: 500;
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      background-color: #eef2ff;
      color: #4338ca;
    }
    .status-text {
      min-height: 24px;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>

<!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
  <div class="container-fluid px-4">
    <a class="navbar-brand d-flex align-items-center" href="#">
      <span class="me-2">âš¾</span>
      <span>ì•¼êµ¬ í¬ì§€ì…˜ ì¸ì‹ ì—°êµ¬ ë°ëª¨</span>
    </a>
    <div class="d-none d-md-flex align-items-center gap-3">
      <span class="badge bg-secondary">
        YOLOv8m Â· 7-class detector
      </span>
      <span class="badge bg-outline-light border border-light text-light">
        Backend: FastAPI
      </span>
      <span class="badge bg-outline-light border border-light text-light">
        Frontend: Bootstrap Â· jQuery Â· Ajax
      </span>
    </div>
  </div>
</nav>

<div class="container-fluid px-4 py-3">
  <div class="row mb-3">
    <div class="col-12 d-flex justify-content-between align-items-end flex-wrap gap-2">
      <div>
        <h4 class="mb-1">í¬ì§€ì…˜ ì¸ì‹ ì‹¤í—˜ ì¸í„°í˜ì´ìŠ¤</h4>
        <div class="page-subtitle">
          ì´ë¯¸ì§€ / í´ë” / ë™ì˜ìƒ ì—…ë¡œë“œ â†’ ëª¨ë¸ ì¶”ë¡  â†’ ë¼ë²¨/ì¢Œí‘œ/ìš”ì•½ í™•ì¸ â†’ ì‹¤í—˜ ê²°ê³¼ ì €ì¥ê¹Œì§€ í•œ ë²ˆì— ìˆ˜í–‰í•˜ëŠ” ì—°êµ¬ìš© UI
        </div>
      </div>
      <div class="text-end">
        <span class="metric-badge me-1">ì…ë ¥: Image Â· Folder Â· Video</span>
        <span class="metric-badge me-1">ì¶œë ¥: judge, batter, catcher, pitcher, infielder, outfielder, runner</span>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- ì™¼ìª½ íŒ¨ë„: ì—…ë¡œë“œ / ì»¨íŠ¸ë¡¤ / ë¼ë²¨ ì •ë³´ -->
    <div class="col-lg-4">
      <!-- ì—…ë¡œë“œ ì˜ì—­ -->
      <div class="upload-area mb-3" id="uploadArea">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <h6 class="mb-0">1. ì…ë ¥ ë°ì´í„° ì„ íƒ</h6>
            <small class="text-muted">ë‹¨ì¼ ì´ë¯¸ì§€, í´ë”(ì´ë¯¸ì§€ ë°°ì¹˜), ë˜ëŠ” ë™ì˜ìƒì„ ì„ íƒí•´ ì‹¤í—˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
          </div>
          <span class="upload-icon text-primary">ğŸ“¥</span>
        </div>

        <!-- ë‹¨ì¼ ì´ë¯¸ì§€ -->
        <label class="form-label small mb-1 text-muted">ë‹¨ì¼ ì´ë¯¸ì§€ ì„ íƒ</label>
        <input type="file" id="imageInput" accept="image/*" class="form-control mb-1">
        <div class="small text-muted mb-2" id="fileInfoText">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</div>

        <!-- í´ë” ì—…ë¡œë“œ ëª¨ë“œ -->
        <div class="border-top pt-2 mt-2">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <div>
              <small class="text-muted fw-semibold">í´ë” ì—…ë¡œë“œ ëª¨ë“œ (ì´ë¯¸ì§€ ë°°ì¹˜ ì‹¤í—˜)</small><br>
              <small class="text-muted">í•œ ë²ˆ ì„ íƒ í›„ [ë‹¤ìŒ] ë²„íŠ¼ìœ¼ë¡œ ìˆœì°¨ì ìœ¼ë¡œ ì´ë¯¸ì§€ ì˜ˆì¸¡ ì‹¤í–‰</small>
            </div>
          </div>
          <input type="file" id="folderInput" webkitdirectory multiple
                 class="form-control form-control-sm mb-2">
          <div class="d-flex justify-content-between align-items-center">
            <div class="small text-muted" id="folderInfoText">í´ë” ë¯¸ì„ íƒ</div>
            <div class="btn-group btn-group-sm" role="group">
              <button type="button" class="btn btn-outline-secondary" id="btnPrevFolder" disabled>ì´ì „</button>
              <button type="button" class="btn btn-outline-secondary" id="btnNextFolder" disabled>ë‹¤ìŒ</button>
            </div>
          </div>
        </div>

        <!-- ë™ì˜ìƒ ì—…ë¡œë“œ -->
        <div class="border-top pt-2 mt-3">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <div>
              <small class="text-muted fw-semibold">ë™ì˜ìƒ ì—…ë¡œë“œ (ì—°ì† í”„ë ˆì„ ì‹¤í—˜)</small><br>
              <small class="text-muted">í•œ ê°œì˜ ë™ì˜ìƒì„ ì—…ë¡œë“œí•˜ì—¬ ì „ì²´ í”„ë ˆì„ì˜ í¬ì§€ì…˜ ì¸ì‹ ìš”ì•½ì„ í™•ì¸í•©ë‹ˆë‹¤.</small>
            </div>
          </div>
          <input type="file" id="videoInput" accept="video/*" class="form-control form-control-sm mb-1">
          <div class="small text-muted mb-1" id="videoInfoText">ì„ íƒëœ ë™ì˜ìƒ ì—†ìŒ</div>
          <button id="btnPredictVideo" class="btn btn-outline-primary btn-sm w-100">
            ë™ì˜ìƒ ì˜ˆì¸¡ ì‹¤í–‰
          </button>
        </div>

        <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
        <div class="d-flex gap-2 mt-3">
          <button id="btnPredict" class="btn btn-primary flex-grow-1">
            ì´ë¯¸ì§€ ì˜ˆì¸¡ ì‹¤í–‰
          </button>
          <button id="btnClear" class="btn btn-outline-secondary">
            ì´ˆê¸°í™”
          </button>
        </div>
        <div class="mt-2 d-flex justify-content-between align-items-center">
          <div class="status-text text-muted" id="statusText"></div>
        </div>
      </div>

      <!-- ë¼ë²¨/ìš”ì•½ í…Œì´ë¸” -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center py-2">
          <span>2. ì˜ˆì¸¡ ê²°ê³¼ (ë¼ë²¨ / ì¢Œí‘œ / ìš”ì•½)</span>
          <span class="badge rounded-pill bg-light text-dark border">
            Detection / Summary Table
          </span>
        </div>
        <div class="card-body scroll-table p-0">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
            <tr>
              <th style="width: 6%;">#</th>
              <th style="width: 30%;">í´ë˜ìŠ¤</th>
              <th style="width: 16%;">Conf / Count</th>
              <th style="width: 12%;">x1</th>
              <th style="width: 12%;">y1</th>
              <th style="width: 12%;">x2</th>
              <th style="width: 12%;">y2</th>
            </tr>
            </thead>
            <tbody id="resultTableBody">
            <tr>
              <td colspan="7" class="text-center text-muted py-3">
                ì•„ì§ ì˜ˆì¸¡ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ì €ì¥ ë²„íŠ¼ (ì´ë¯¸ì§€ ê²°ê³¼ìš©) -->
      <div class="card">
        <div class="card-body py-2 d-flex justify-content-between align-items-center">
          <div>
            <div class="fw-semibold mb-0">3. ì‹¤í—˜ ê²°ê³¼ ì €ì¥ (ì´ë¯¸ì§€)</div>
            <small class="text-muted">
              í˜„ì¬ ì´ë¯¸ì§€ ì˜ˆì¸¡ ê²°ê³¼ë¥¼ ì—°êµ¬ ë¡œê·¸(saved_results.json)ì— ì¶”ê°€í•©ë‹ˆë‹¤.
            </small>
          </div>
          <button id="btnSave" class="btn btn-outline-success" disabled>
            ì €ì¥í•˜ê¸°
          </button>
        </div>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½ íŒ¨ë„: ì´ë¯¸ì§€/ë™ì˜ìƒ + ì €ì¥ëœ ê²°ê³¼ ëª©ë¡ -->
    <div class="col-lg-8">
      <!-- ê²°ê³¼ ì‹œê°í™” -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center py-2">
          <div>
            <span>ì˜ˆì¸¡ ì‹œê°í™”</span>
            <small class="text-muted d-block" style="font-size: 0.8rem;">
              ì´ë¯¸ì§€: Bounding box Â· ë¼ë²¨ Â· confidence / ë™ì˜ìƒ: í”„ë ˆì„ë³„ ì¸ì‹ ê²°ê³¼ ì˜ìƒ
            </small>
          </div>
          <div class="d-flex align-items-center gap-2">
            <label for="zoomRange" class="form-label mb-0 small text-muted">Image Zoom</label>
            <input type="range" id="zoomRange" min="50" max="200" value="100"
                   class="form-range" style="width: 140px;">
            <span id="zoomLabel" class="small text-muted">100%</span>
          </div>
        </div>
        <div class="card-body">
          <div class="result-img-wrapper">
            <img id="resultImage" class="result-img d-none" alt="ì˜ˆì¸¡ ê²°ê³¼ ì´ë¯¸ì§€">
            <video id="resultVideo" class="result-video d-none" controls></video>
            <span id="noImageText" class="text-muted">
              ì¢Œì¸¡ì—ì„œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ í´ë”/ë™ì˜ìƒì„ ì„ íƒí•œ ë’¤ <strong>ì˜ˆì¸¡ ì‹¤í–‰</strong>ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
            </span>
          </div>
        </div>
      </div>

      <!-- ì €ì¥ëœ ê²°ê³¼ ëª©ë¡ (ì´ë¯¸ì§€) -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center py-2">
          <span>ì €ì¥ëœ ì´ë¯¸ì§€ ì‹¤í—˜ ê²°ê³¼ ëª©ë¡</span>
          <button class="btn btn-sm btn-outline-secondary" type="button" onclick="refreshSavedTable()">
            ìƒˆë¡œê³ ì¹¨
          </button>
        </div>
        <div class="card-body scroll-table p-0">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
            <tr>
              <th style="width: 6%;">#</th>
              <th style="width: 40%;">íŒŒì¼ëª…</th>
              <th style="width: 14%;">ë°•ìŠ¤ ê°œìˆ˜</th>
              <th style="width: 20%;">ì´ë¯¸ì§€</th>
              <th style="width: 20%;">ê¸°íƒ€</th>
            </tr>
            </thead>
            <tbody id="savedTableBody">
            {% if saved_results and saved_results|length > 0 %}
              {% for item in saved_results %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td class="text-truncate" title="{{ item["original_filename"] }}">
                    {{ item["original_filename"] }}
                  </td>
                  <td>{{ item["detections"]|length }}</td>
                  <td>
                    <a href="{{ item["input_image_url"] }}" target="_blank" class="link-primary">ë³´ê¸°</a>
                  </td>
                  <td>
                    <span class="badge bg-light text-dark border">
                      ID: {{ item["id"][:8] }}â€¦
                    </span>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="5" class="text-center text-muted py-3">
                  ì•„ì§ ì €ì¥ëœ ì‹¤í—˜ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
                </td>
              </tr>
            {% endif %}
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  let lastResult = null;           // ë§ˆì§€ë§‰ ì´ë¯¸ì§€ ì˜ˆì¸¡ ê²°ê³¼ (ì €ì¥ìš©)
  let currentZoom = 1.0;
  let folderFiles = [];            // í´ë” ëª¨ë“œì—ì„œ ì„ íƒí•œ íŒŒì¼ ë¦¬ìŠ¤íŠ¸ (ì´ë¯¸ì§€)
  let currentFolderIndex = -1;     // í˜„ì¬ í´ë” ë‚´ ì¸ë±ìŠ¤

  // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
  function setStatus(text, isError = false) {
    const $status = $('#statusText');
    $status.text(text);
    $status.removeClass('text-danger text-success');
    if (isError) {
      $status.addClass('text-danger');
    } else if (text) {
      $status.addClass('text-success');
    }
  }

  // ê²°ê³¼ í…Œì´ë¸” ì´ˆê¸°í™”
  function clearTable() {
    $('#resultTableBody').html(
      '<tr><td colspan="7" class="text-center text-muted py-3">ì•„ì§ ì˜ˆì¸¡ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'
    );
  }

  // í´ë” ì •ë³´ í…ìŠ¤íŠ¸ ë° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  function updateFolderInfo() {
    const $info = $('#folderInfoText');
    const $btnPrev = $('#btnPrevFolder');
    const $btnNext = $('#btnNextFolder');

    if (!folderFiles || folderFiles.length === 0) {
      $info.text('í´ë” ë¯¸ì„ íƒ');
      $btnPrev.prop('disabled', true);
      $btnNext.prop('disabled', true);
      return;
    }

    if (currentFolderIndex < 0) currentFolderIndex = 0;
    if (currentFolderIndex >= folderFiles.length) currentFolderIndex = folderFiles.length - 1;

    const currentFile = folderFiles[currentFolderIndex];
    const total = folderFiles.length;

    let folderName = '';
    if (currentFile.webkitRelativePath) {
      const parts = currentFile.webkitRelativePath.split('/');
      if (parts.length > 1) {
        folderName = parts[0];
      }
    }
    const nameText = folderName
      ? `í´ë”: ${folderName} Â· (${currentFolderIndex + 1}/${total})`
      : `(${currentFolderIndex + 1}/${total})`;

    $info.text(nameText + ` Â· íŒŒì¼: ${currentFile.name}`);
    $btnPrev.prop('disabled', currentFolderIndex <= 0);
    $btnNext.prop('disabled', currentFolderIndex >= total - 1);
  }

  // ì—…ë¡œë“œ ë°•ìŠ¤ ë“œë˜ê·¸ & ë“œë¡­ íš¨ê³¼ (ì´ë¯¸ì§€)
  const $uploadArea = $('#uploadArea');
  $uploadArea.on('dragover', function (e) {
    e.preventDefault();
    e.stopPropagation();
    $uploadArea.addClass('dragover');
  });
  $uploadArea.on('dragleave drop', function (e) {
    e.preventDefault();
    e.stopPropagation();
    $uploadArea.removeClass('dragover');
  });
  $uploadArea.on('drop', function (e) {
    const files = e.originalEvent.dataTransfer.files;
    if (files && files.length > 0) {
      $('#imageInput')[0].files = files;
      $('#fileInfoText').text('ì„ íƒëœ íŒŒì¼: ' + files[0].name);
      // í´ë”/ë™ì˜ìƒì€ ë³€ê²½í•˜ì§€ ì•ŠìŒ
    }
  });

  // ë‹¨ì¼ ì´ë¯¸ì§€ ì„ íƒ ì‹œ
  $('#imageInput').on('change', function () {
    const file = this.files && this.files[0];
    if (file) {
      $('#fileInfoText').text('ì„ íƒëœ íŒŒì¼: ' + file.name);
      // ë‹¨ì¼ íŒŒì¼ ì„ íƒí•˜ë©´ í´ë” ëª¨ë“œ ì´ˆê¸°í™”
      folderFiles = [];
      currentFolderIndex = -1;
      updateFolderInfo();
    } else {
      $('#fileInfoText').text('ì„ íƒëœ íŒŒì¼ ì—†ìŒ');
    }
  });

  // í´ë” ì„ íƒ ì‹œ (ì´ë¯¸ì§€ ë°°ì¹˜)
  $('#folderInput').on('change', function () {
    const files = Array.from(this.files || []);
    folderFiles = files.filter(f => f.type.startsWith('image/'));
    currentFolderIndex = 0;

    $('#imageInput').val('');
    $('#fileInfoText').text('ì„ íƒëœ íŒŒì¼ ì—†ìŒ');

    if (folderFiles.length === 0) {
      $('#folderInfoText').text('í´ë” ë‚´ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }
    updateFolderInfo();
    setStatus('í´ë” ëª¨ë“œ í™œì„±í™”: [ë‹¤ìŒ] ë²„íŠ¼ìœ¼ë¡œ ìˆœì°¨ ì´ë¯¸ì§€ ì˜ˆì¸¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
  });

  // ì´ì „ / ë‹¤ìŒ ë²„íŠ¼ (í´ë” ëª¨ë“œ)
  $('#btnPrevFolder').on('click', function () {
    if (!folderFiles || folderFiles.length === 0) return;
    if (currentFolderIndex > 0) {
      currentFolderIndex--;
      updateFolderInfo();
      $('#btnPredict').click();
    }
  });

  $('#btnNextFolder').on('click', function () {
    if (!folderFiles || folderFiles.length === 0) return;
    if (currentFolderIndex < folderFiles.length - 1) {
      currentFolderIndex++;
      updateFolderInfo();
      $('#btnPredict').click();
    }
  });

  // ë™ì˜ìƒ ì„ íƒ ì‹œ
  $('#videoInput').on('change', function () {
    const file = this.files && this.files[0];
    if (file) {
      $('#videoInfoText').text('ì„ íƒëœ ë™ì˜ìƒ: ' + file.name);
    } else {
      $('#videoInfoText').text('ì„ íƒëœ ë™ì˜ìƒ ì—†ìŒ');
    }
  });

  // ì´ë¯¸ì§€ ì˜ˆì¸¡ ë²„íŠ¼ í´ë¦­ (ë‹¨ì¼ + í´ë”)
  $('#btnPredict').on('click', function () {
    const formData = new FormData();
    let fileToSend = null;

    // í´ë” ëª¨ë“œ ìš°ì„ 
    if (folderFiles.length > 0 && currentFolderIndex >= 0 && currentFolderIndex < folderFiles.length) {
      fileToSend = folderFiles[currentFolderIndex];
    } else {
      const fileInput = $('#imageInput')[0];
      if (!fileInput.files || fileInput.files.length === 0) {
        setStatus('ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ê±°ë‚˜ í´ë”ë¥¼ ì§€ì •í•´ì£¼ì„¸ìš”.', true);
        return;
      }
      fileToSend = fileInput.files[0];
    }

    formData.append('file', fileToSend);

    const fileLabel = fileToSend.name || 'ì„ íƒëœ ì´ë¯¸ì§€';
    setStatus(`ì´ë¯¸ì§€ ì˜ˆì¸¡ ì¤‘ì…ë‹ˆë‹¤: ${fileLabel}`, false);
    $('#btnPredict').prop('disabled', true);
    $('#btnSave').prop('disabled', true);
    clearTable();

    // ì˜ìƒ ë·° ë„ê³  ì´ë¯¸ì§€ ëª¨ë“œë¡œ
    $('#resultVideo').addClass('d-none').attr('src', '');
    $('#resultImage').removeClass('d-none');
    $('#noImageText').addClass('d-none');

    $.ajax({
      url: '/api/predict',
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      success: function (res) {
        lastResult = res;

        $('#resultImage')
          .attr('src', res.input_image_url + '?v=' + Date.now())
          .removeClass('d-none');
        $('#noImageText').addClass('d-none');

        const $tbody = $('#resultTableBody');
        $tbody.empty();

        if (!res.detections || res.detections.length === 0) {
          $tbody.append(
            '<tr><td colspan="7" class="text-center text-muted py-3">ê°ì§€ëœ ê°ì²´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'
          );
        } else {
          res.detections.forEach((det, idx) => {
            const row = `
              <tr>
                <td>${idx + 1}</td>
                <td>${det.class_name}</td>
                <td>${det.confidence}</td>
                <td>${det.x1}</td>
                <td>${det.y1}</td>
                <td>${det.x2}</td>
                <td>${det.y2}</td>
              </tr>
            `;
            $tbody.append(row);
          });
        }

        if (folderFiles.length > 0) {
          setStatus(
            `ì´ë¯¸ì§€ ì˜ˆì¸¡ ì™„ë£Œ (${currentFolderIndex + 1}/${folderFiles.length}) Â· ${fileLabel}`,
            false
          );
        } else {
          setStatus(`ì´ë¯¸ì§€ ì˜ˆì¸¡ ì™„ë£Œ Â· ${fileLabel}`, false);
        }

        $('#btnSave').prop('disabled', false);
      },
      error: function (xhr) {
        console.error(xhr);
        setStatus('ì´ë¯¸ì§€ ì˜ˆì¸¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', true);
      },
      complete: function () {
        $('#btnPredict').prop('disabled', false);
      }
    });
  });

  // âœ… ë™ì˜ìƒ ì˜ˆì¸¡ ë²„íŠ¼ í´ë¦­ (ìˆ˜ì • ë²„ì „)
  $('#btnPredictVideo').on('click', function () {
    const videoInput = $('#videoInput')[0];
    if (!videoInput.files || videoInput.files.length === 0) {
      setStatus('ë¨¼ì € ë™ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.', true);
      return;
    }
    const file = videoInput.files[0];
    const formData = new FormData();
    formData.append('file', file);

    setStatus(`ë™ì˜ìƒ ì˜ˆì¸¡ ì¤‘ì…ë‹ˆë‹¤: ${file.name} (ê¸¸ì´ì— ë”°ë¼ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)`, false);
    $('#btnPredictVideo').prop('disabled', true);
    clearTable();

    // ì´ë¯¸ì§€ ë·° ë„ê³  ë™ì˜ìƒ ëª¨ë“œë¡œ
    $('#resultImage').addClass('d-none').attr('src', '');
    $('#noImageText').addClass('d-none');

    const $video = $('#resultVideo');
    const videoEl = $video.get(0);
    $video.removeClass('d-none');

    // ì´ì „ ì†ŒìŠ¤ ì œê±°
    while (videoEl.firstChild) {
      videoEl.removeChild(videoEl.firstChild);
    }

    $.ajax({
      url: '/api/predict_video',
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      success: function (res) {
        console.log('video predict response:', res);

        if (res.video_url) {
          // <source> íƒœê·¸ë¥¼ ìƒˆë¡œ ë§Œë“¤ì–´ì„œ videoì— ì¶”ê°€
          const source = document.createElement('source');
          source.src = res.video_url + '?v=' + Date.now();  // ìºì‹± ë°©ì§€
          source.type = 'video/mp4';
          videoEl.appendChild(source);

          // ë¡œë“œ + ì¬ìƒ
          videoEl.load();
          videoEl.play().catch(err => {
            console.log('ìë™ ì¬ìƒì´ ë§‰í˜”ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:', err);
          });
        } else {
          setStatus('ì„œë²„ì—ì„œ video_urlì„ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', true);
        }

        const $tbody = $('#resultTableBody');
        $tbody.empty();

        if (!res.summary || res.summary.length === 0) {
          $tbody.append(
            '<tr><td colspan="7" class="text-center text-muted py-3">ê°ì§€ëœ ê°ì²´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'
          );
        } else {
          res.summary.forEach((item, idx) => {
            const row = `
              <tr>
                <td>${idx + 1}</td>
                <td>${item.class_name}</td>
                <td>${item.count}</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
              </tr>
            `;
            $tbody.append(row);
          });
        }

        setStatus(`ë™ì˜ìƒ ì˜ˆì¸¡ ì™„ë£Œ Â· ${file.name}`, false);
      },
      error: function (xhr) {
        console.error(xhr);
        setStatus('ë™ì˜ìƒ ì˜ˆì¸¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', true);
      },
      complete: function () {
        $('#btnPredictVideo').prop('disabled', false);
      }
    });
  });

  // ì´ë¯¸ì§€ ê²°ê³¼ ì €ì¥ ë²„íŠ¼
  $('#btnSave').on('click', function () {
    if (!lastResult) {
      setStatus('ì €ì¥í•  ì´ë¯¸ì§€ ì˜ˆì¸¡ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', true);
      return;
    }

    $.ajax({
      url: '/api/save',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(lastResult),
      success: function (res) {
        setStatus('ì´ë¯¸ì§€ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ì´ ' + res.count + 'ê°œ)', false);
        $('#btnSave').prop('disabled', true);
        refreshSavedTable();
      },
      error: function (xhr) {
        console.error(xhr);
        setStatus('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', true);
      }
    });
  });

  // ì €ì¥ëœ ê²°ê³¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ì´ë¯¸ì§€)
  function refreshSavedTable() {
    $.get('/api/saved', function (data) {
      const results = data.results || [];
      const $tbody = $('#savedTableBody');
      $tbody.empty();

      if (results.length === 0) {
        $tbody.append(
          '<tr><td colspan="5" class="text-center text-muted py-3">ì•„ì§ ì €ì¥ëœ ì‹¤í—˜ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'
        );
      } else {
        results.forEach((item, idx) => {
          const row = `
            <tr>
              <td>${idx + 1}</td>
              <td class="text-truncate" title="${item.original_filename}">
                ${item.original_filename}
              </td>
              <td>${item.detections.length}</td>
              <td><a href="${item.input_image_url}" target="_blank" class="link-primary">ë³´ê¸°</a></td>
              <td><span class="badge bg-light text-dark border">ID: ${item.id.substring(0, 8)}â€¦</span></td>
            </tr>
          `;
          $tbody.append(row);
        });
      }
    });
  }

  // ì¤Œ ìŠ¬ë¼ì´ë” (ì´ë¯¸ì§€ìš©)
  $('#zoomRange').on('input', function () {
    const value = parseInt($(this).val(), 10);
    currentZoom = value / 100.0;
    $('#zoomLabel').text(value + '%');
    $('#resultImage').css('transform', 'scale(' + currentZoom + ')');
  });

  // ì´ˆê¸°í™” ë²„íŠ¼
  $('#btnClear').on('click', function () {
    $('#imageInput').val('');
    $('#fileInfoText').text('ì„ íƒëœ íŒŒì¼ ì—†ìŒ');

    $('#folderInput').val('');
    folderFiles = [];
    currentFolderIndex = -1;
    updateFolderInfo();

    $('#videoInput').val('');
    $('#videoInfoText').text('ì„ íƒëœ ë™ì˜ìƒ ì—†ìŒ');

    lastResult = null;
    clearTable();

    $('#resultImage').addClass('d-none').attr('src', '');
    $('#resultVideo').addClass('d-none').attr('src', '');
    $('#noImageText').removeClass('d-none');

    $('#btnSave').prop('disabled', true);
    setStatus('');
  });
</script>

</body>
</html>
